image: jangrewe/gitlab-ci-android:33

stages:
  - lint
  - tests
  - build_flavors
  - release
  - create_git_tag


before_script:
  - chmod +x ./gradlew


runAndroidLint:
  stage: lint
  script:
    - ./gradlew lint
  artifacts:
    paths:
      - "**/lint-results.html"
    expire_in: 10 days
    when: always
#  rules:
#    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'


runUnitTests:
  stage: tests
  script:
    - ./gradlew app:test

  artifacts:
    paths:
      - "**/build/reports/tests/testDebugUnitTest/classes"
      - "**/build/reports/tests/testDebugUnitTest/packages"
      - "**/build/reports/tests/testDebugUnitTest/index.html"
    expire_in: 10 days
    when: always
#  rules:
#    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

#

runAndroidTestUsingMarathon:
  stage: tests
  script:
    - ./gradlew app:assembleSomeBuildFlavorDebug
    - ./gradlew app:assembleSomeBuildFlavorDebugAndroidTest

    - VERSION="1.0.46"
    - curl --location https://github.com/MarathonLabs/marathon-cloud-cli/releases/download/${VERSION}/marathon-cloud-v${VERSION}-linux --output /tmp/marathon-cloud
    - mkdir -p /marathon
    - tar -xzf /tmp/marathon-cloud --directory /marathon
    - mv /marathon/marathon-cloud-v${VERSION}-linux/marathon-cloud /usr/local/bin/
    - chmod +x /usr/local/bin/marathon-cloud
    - marathon-cloud devices android
    - marathon-cloud run android --application "app/build/outputs/apk/debug/app-debug.apk" --test-application "app/build/outputs/apk/androidTest/debug/app-debug-androidTest.apk" --name ${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME} --project ${MARATHON_CLOUD_PROJECT_ID}
#  rules:
#    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "master"'

assembleSomeBuildFlavor:
  stage: build_flavors
  script:
    - ./gradlew assembleSomeBuildFlavorDebug
  artifacts:
    paths:
      - app/build/outputs/apk/test_flavor_name/
    expire_in: 10 days
#  rules:
#    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "develop"'